/*! shoretransit 2014-02-19 */
$(document).ready(function(){var a=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928","#a6cee3","#1f78b4","#b2df8a","#33a02c","#fdbf6f","#ff7f00"],b=Backbone.View.extend({mapTemplate:$("#map-template").html(),busIcon:L.icon({iconUrl:"img/bus-18.png",iconRetinaUrl:"img/bus-18@2x.png",iconSize:[18,18],popupAnchor:[1,-5]}),initialize:function(){this.render(),this.listenTo(o.filterCollection,"all",this.update)},render:function(){return this.$el.html(Mustache.render(this.mapTemplate)),this.makeMap(),this},makeMap:function(){var a=this,b=this.$el.find(".map")[0];this.map=L.map(b).setView([38.25,-75.5],10),L.tileLayer("http://{s}.tiles.mapbox.com/v3/esrgc.map-y9awf40v/{z}/{x}/{y}.png").addTo(this.map),this.stopLayer=new L.featureGroup,this.map.addLayer(this.stopLayer),this.routesLayer=new L.geoJson,$.get("data/stroutes.json",function(b){a.routesGeoJSON=b,a.update()})},addStops:function(a){var b=this;if(this.stopLayer.clearLayers(),_.each(a,function(a){var c=L.marker([a.lat,a.lng],{icon:b.busIcon}).bindPopup("<b>Stop</b><br>"+a.id+"<br>"+a.name);b.stopLayer.addLayer(c)}),a.length>1){var c=b.stopLayer.getBounds();b.map.fitBounds(c)}else 1==a.length&&b.map.setView([a[0].lat,a[0].lng],14)},addRoutes:function(b){var c=this,d=0,e={color:"#F06730",weight:3,opacity:1},f=function(b,c){b.properties&&b.properties.Name&&c.bindPopup("<b>Route</b><br>"+b.properties.route_refi+"<br>"+b.properties.Name),a[d]&&(e.color=a[d]),c.setStyle(e),d+=1},g=function(a){return c.routesToShow.indexOf(a.properties.route_refi)>=0?!0:!1};this.routesLayer.clearLayers(),this.routesLayer=L.geoJson(b,{onEachFeature:f,filter:g}).addTo(this.map)},update:function(){var a=this,b="getStopsMap",c="getRoutesMap",d="?"+$.param(o.filterCollection.toJSON());b+=d,c+=d,$.getJSON(b,function(b){a.addStops(b)}),$.getJSON(c,function(b){a.routesToShow=_.pluck(b,"id"),a.addRoutes(a.routesGeoJSON)})}}),c=Backbone.Model.extend({defaults:function(){return{api:"/getRoutes",title:"Chart Title",sort_key:!1,sort_desc:!0}},initialize:function(){this.update(),this.listenTo(o.filterCollection,"change",this.update),this.listenTo(o.filterCollection,"add",this.update),this.listenTo(o.filterCollection,"remove",this.update)},update:function(){var a=this,b=this.get("api");b+="?"+$.param(o.filterCollection.toJSON()),$.getJSON(b,function(b){a.set("data",b)})},sortByKey:function(a){var b=this.get("data");if(this.get("sort_key"))if(this.get("sort_key")===a){var c=this.get("sort_desc");this.set("sort_desc",!c)}else this.get("sort_key")!==a&&(this.set("sort_key",a),this.set("sort_desc",!0));else this.set("sort_key",a),this.set("sort_desc",!0);b=this.get("sort_desc")?_.sortBy(b,function(b){return b[a]}).reverse():_.sortBy(b,function(b){return b[a]}),this.set("data",b)}}),d=Backbone.Collection.extend({model:c}),e=Backbone.View.extend({template:$("#chart-template").html(),events:{"click .download":"download","click .code":"code"},initialize:function(){this.render(),this.listenTo(this.model,"change:data",this.render)},render:function(){return this.$el.html(Mustache.render(this.template,this.model.toJSON(),{title:$("#title-partial").html()})),this},prepData:function(a){return a},download:function(){var a=$.param(o.filterCollection.toJSON()),b=this.model.get("api")+"?csv=true&"+a;window.open(b)},code:function(){var a=$.param(o.filterCollection.toJSON()),b=this.model.get("api")+"?"+a;window.open(b)}}),f=Backbone.Model.extend({defaults:function(){return{}},initialize:function(){this.get("display")||this.set("display",this.get("value"))}}),g=Backbone.Collection.extend({model:f}),h=e.extend({template:$("#filter-template").html(),events:{'click button[type="submit"]':"submitForm","click button.clear":"clear"},initialize:function(){this.render(),this.listenTo(o.filterCollection,"remove",this.render),this.listenTo(o.filterCollection,"add",this.render)},render:function(){var a=this,b={};return b.title="Filters",this.$el.html(Mustache.render(this.template,b,{title:$("#title-partial").html()})),o.filterCollection.each(function(b){var c=a.$el.find(':input[name="'+b.get("name")+'"]'),d=b.get("value");1==c.length?$(c).val(d):c.length>1&&c.each(function(a,b){d.indexOf(b.value)<0&&(b.checked=!1)})}),this},clear:function(a){a.preventDefault()},getAttributes:function(){var a=this;a.$el.find(".filter").each(function(a,b){var c=$(b).find(":input");if(c.length){var d=$(b).find(":checkbox:checked").map(function(){return this.value}).get().join(",");d||(d=$(c).val());var e=$(c).get(0).name,f=o.filterCollection.where({name:e});f.length?(f[0].set("value",d),f[0].set("display",d)):o.filterCollection.add({name:e,value:d})}})},submitForm:function(a){a.preventDefault(),this.getAttributes()}}),i=e.extend({template:$("#table-template").html(),events:function(){return _.extend({},e.prototype.events,{"click th":"sortByHeader","click td.grouper":"setGroupBy"})},render:function(){var a=this,b=this.model.toJSON();return b.data&&(b.data=this.prepData(b.data)),this.$el.html(Mustache.render(this.template,b,{title:$("#title-partial").html(),toolbar:$("#toolbar-partial").html()})),this.$el.find("th").each(function(b,c){c.innerHTML===a.model.get("sort_key")&&$(c).addClass("sort")}),this.$el.find("tbody tr").each(function(a,b){var c=$(b).find("td")[0];$(c).addClass("grouper")}),this},prepData:function(a){var b={rows:[],columns:[]};if(a.length){var c=[];_.each(a,function(a){c.push(_.omit(a,["ID","Short","Long"]))});var d=_.keys(c[0]);b.columns=d,_.each(c,function(a){b.rows.push({row:_.values(a)})})}return b},sortByHeader:function(a){var b=a.target.innerHTML;this.model.sortByKey(b)},setGroupBy:function(a){var b=this.model.get("groupBy"),c=$("<div />").html($(a.target).html()).text(),d=_.where(this.model.get("data"),{Name:c})[0].ID,e=o.filterCollection.where({name:b});e.length?e[0].set({name:b,value:d,display:c}):o.filterCollection.add([{name:b,value:d,display:c}])}}),j=e.extend({initialize:function(){this.render(),this.listenTo(this.model,"change:data",this.update)},render:function(){return this.$el.html(Mustache.render(this.template,this.model.toJSON(),{title:$("#title-partial").html(),toolbar:$("#toolbar-partial").html()})),this.drawChart(),this.$el.find(".chart-inner").css("overflow","hidden"),this},drawChart:function(){var a=this.$el.find(".chart-inner").selector;this.chart=new GeoDash.BarChartHorizontal(a,{y:"Name",x:["On","Off"],colors:["#F06730","#66A7E1"],xTickFormat:d3.format(".2s"),yWidth:60})},update:function(){this.chart.update(this.prepData(this.model.get("data")))}}),k=j.extend({drawChart:function(){var a=this.$el.find(".chart-inner").selector;this.chart=new GeoDash.LineChart(a,{x:"Date",y:["111a","111r"],colors:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],legend:!0,legendWidth:50,money:!0,hoverTemplate:"{{x}}: ${{y}}",interpolate:"none",xTickFormat:d3.time.format("%m/%d"),yTicksCount:5})},prepData:function(a){var b=[];_.each(a,function(a){b.push(_.keys(_.omit(a,"Date")))}),b=_.uniq(_.flatten(b)),this.chart.options.y=b;var c=d3.time.format("%Y-%m-%d").parse;return _.each(a,function(a){a.Date=c(a.Date)}),a}}),l=Backbone.View.extend({template:$("#filter-label-template").html(),tagName:"div",className:"filter-label",events:{"click .remove":"removeFilter"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(Mustache.render(this.template,this.model.toJSON())),this},removeFilter:function(){this.model.destroy()}}),m=Backbone.View.extend({template:$("#summary-template").html(),events:{},initialize:function(){this.render(),this.listenTo(o.filterCollection,"add",this.addOne)},addOne:function(a){var b=new l({model:a});this.$(".filter-labels").append(b.render().el)},addAll:function(){o.filterCollection.each(this.addOne,this)},render:function(){return this.$el.html(Mustache.render(this.template)),this.addAll(),this}}),n=Backbone.View.extend({initialize:function(){},render:function(){this.filterCollection=new g,this.filterCollection.add([{name:"startDate",value:"1970-01-01"},{name:"endDate",value:"2015-01-01"},{name:"days",value:["1","2","3","4","5","6","7"]},{name:"passType",value:"All"}]),this.filterMenuView=new h({el:".block1"}),this.summaryView=new m({el:".block9"}),this.mapView=new b({el:".block3"}),this.chartCollection=new d,this.chartCollection.add([{title:"Ridership By Route",api:"getPassengersByRoute",groupBy:"route"},{title:"Ridership By Shift",api:"getPassengersByShift",groupBy:"shift"},{title:"Ridership By Trip",api:"getPassengersByTrip",groupBy:"trip"},{title:"Ridership By Stop",api:"getPassengersByStop",groupBy:"stop"},{title:"Ridership By Grant",api:"getPassengersByGrant"},{title:"Revenue",api:"getFares"}]),new i({model:this.chartCollection.at(0),el:".block2"}),new j({model:this.chartCollection.at(4),el:".block4"}),new i({model:this.chartCollection.at(1),el:".block5"}),new i({model:this.chartCollection.at(2),el:".block6"}),new k({model:this.chartCollection.at(5),el:".block7"}),new i({model:this.chartCollection.at(3),el:".block8"})}}),o=new n;o.render()});